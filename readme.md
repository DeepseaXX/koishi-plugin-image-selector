# koishi-plugin-image-selector

[![npm](https://img.shields.io/npm/v/@deepseaxx/koishi-plugin-image-selector?style=flat-square)](https://www.npmjs.com/package/@deepseaxx/koishi-plugin-image-selector)

感谢原作者[995837081/koishi-plugin-image-selecter](https://github.com/995837081/koishi-plugin-image-selecter)

## 功能特性

### 🎲 随机发图

- 根据文件夹别名随机发送图片或视频
- 支持多别名系统（用 `-` 分割）
- 支持别名重名时随机选择文件夹
- 支持指令 `图库列表`（可自定义），列出所有文件夹与别名
- 自动识别图片和视频格式
- 支持单次发送多张图片（可配置上限，默认 5 张）：`[关键词] [数量]`（例如：`猪图 3`）

### 📁 用户存图

- 支持多种存图方式：直接传图、回复消息、交互式输入
- 根据指令选项，智能匹配对应文件夹
- 支持多种图片和视频格式
- 基于 MIME 类型的智能文件扩展名检测
- 统一的用户上传权限管理，支持设置默认限制和特定用户限制
- 支持为不同用户配置不同的上传尺寸上限（MB）

### 🔧 高度可配置

- 自定义存图指令名称
- 灵活的文件名模板系统
- 可配置的超时时间
- 单次最大发图数量限制
- 调试模式支持

### 权限配置说明

插件使用 `userLimits` 和 `groupLimits` 列表配合管理上传权限，逻辑如下：

1. **userLimits (用户限制列表)**：
   - 针对特定用户的上传尺寸限制。
   - 必须包含 `default` 项作为全局默认值。

2. **groupLimits (群组限制列表)**：
   - 针对特定群组的上传尺寸限制。
   - 可包含 `default` 项作为群组默认值。

3. **优先级判定逻辑**：
   系统按以下顺序判定限制（一旦匹配则停止）：
   1. **用户独立配置**：检查 `userLimits` 中是否有当前用户的设置。
   2. **群组独立配置**：若在群聊中，检查 `groupLimits` 中是否有当前群组的设置。
   3. **群组默认配置**：若在群聊中，检查 `groupLimits` 中的 `default` 设置。
   4. **全局默认配置**：检查 `userLimits` 中的 `default` 设置。
   5. **最终兜底**：若以上均不存在，默认为 0（禁止上传）。

**配置示例**：
- **场景**：
  - 全局默认禁止上传（`userLimits` default: 0）
  - 允许群 A 全员上传 5MB（`groupLimits` 群A_ID: 5）
  - 但群 A 中的某些恶意用户禁止上传（`userLimits` 恶意用户ID: 0）
  - 管理员在任何地方都允许 100MB（`userLimits` 管理员ID: 100）
  - 任何非法值（如负数）均视为 `0`（禁止上传）。

**典型配置示例**：

- **场景1**：仅允许管理员上传，其他禁止。
  - `default`: 0
  - `管理员ID`: 10

- **场景2**：所有人默认允许上传3MB，VIP用户允许20MB。
  - `default`: 3
  - `VIP用户ID`: 20

## 文件名模板变量

文件名模板支持以下变量：

| 变量             | 说明                | 示例                         |
| ---------------- | ------------------- | ---------------------------- |
| `${userId}`    | 用户ID（QQ号）      | `123456789`                |
| `${username}`  | 用户名              | `张三`                     |
| `${timestamp}` | 时间戳              | `1640995200001`            |
| `${date}`      | 日期（YYYY-MM-DD）  | `2024-01-01`               |
| `${time}`      | 时间（HH-MM-SS）    | `14-30-25`                 |
| `${index}`     | 文件序号（从1开始） | `1`, `2`, `3`          |
| `${ext}`       | 文件扩展名          | `.jpg`, `.png`, `.mp4` |
| `${guildId}`   | 群组ID              | `987654321`                |
| `${channelId}` | 频道ID              | `111222333`                |

### 文件名模板示例

```
${userId}-${timestamp}-${index}${ext}
→ 123456789-1640995200001-1.jpg

${nickname}_${date}_${time}${ext}
→ 张三_2024-01-01_14-30-25.png

${guildId}_${userId}_${index}${ext}
→ 987654321_123456789_1.gif
```

## 文件结构

### 推荐的目录结构

```
项目根目录/
├── images/                    # 图片库目录（imagePath 配置）
│   ├── 角色1-别名1-别名2/      # 文件夹名用 - 分割别名
│   │   ├── image1.jpg
│   │   ├── image2.png
│   │   └── video1.mp4
│   ├── 角色2-萌妹-可爱/
│   │   ├── cute1.gif
│   │   └── cute2.webp
│   ├── 风景-自然-山水/
│   │   ├── nature1.jpg
│   │   └── nature2.png
│   └── 动物-猫咪-喵星人/
│       ├── cat1.jpg
│       ├── cat2.gif
│       └── cat_video.mp4
└── temp/                      # 临时存储目录（tempPath 配置）
    ├── 123456789-1640995200001-1.jpg
    ├── 123456789-1640995200002-2.png
    └── 987654321-1640995200003-1.mp4
```

### 别名系统说明

文件夹名称使用 `-` 分割多个别名，用户输入任意一个别名都能匹配到该文件夹：

```
文件夹名: 角色1-别名1-别名2
用户输入: 角色1  ✅ 匹配
用户输入: 别名1  ✅ 匹配
用户输入: 别名2  ✅ 匹配
用户输入: 其他   ❌ 不匹配
```

### 别名重名处理

当多个文件夹包含相同别名时，系统会：

1. 收集所有匹配的文件夹
2. 随机选择其中一个文件夹
3. 从选定文件夹中随机选择文件
4. 输出警告日志提醒管理员

```
文件夹:
├── 敌意-你好-你好啊/
└── 敌意-第一-帝一/

用户输入: 敌意
→ 系统随机选择其中一个文件夹
→ 输出警告: "检测到别名重名: 输入'敌意'匹配到2个文件夹"
```

## 使用方法

### 存图功能

#### 1. 直接传图

```
存图 [图片1] [图片2] [图片3]
```

#### 2. 回复消息存图

```
用户A: [发送图片]
用户B: 存图  # 回复用户A的消息
```

#### 3. 交互式存图

```
用户: 存图
机器人: 请发送图片或视频
用户: [发送图片]
机器人: 已保存 1 个文件到临时文件夹
```

### 发图功能

直接发送别名即可触发随机发图，也可指定数量：

```
用户: 角色1
机器人: [发送随机图片]

用户: 角色1 3
机器人: [发送随机图片1]
机器人: [发送随机图片2]
机器人: [发送随机图片3]

用户: 角色1 100 (若配置上限为5)
机器人: [发送随机图片1]
...
机器人: [发送随机图片5]

用户: 萌妹abc
机器人: [发送随机图片] (非数字后缀视为1张)

用户: 猫咪
机器人: [发送随机图片或视频]
```

### 图库列表

```
用户: 图库列表
机器人:发送指令【猫图】或别名【猫图】 随机返回图片
狗图
猪图
猫图
```

## 支持的文件格式

### 图片格式

- JPEG/JPG
- PNG
- GIF
- WebP
- BMP
- TIFF

### 视频格式

- MP4
- MOV
- AVI

## 调试模式

启用 `debugMode` 后，插件会输出详细的调试信息：

```
[INFO] 收到消息: { userId: '123456789', content: '角色1' }
[INFO] 匹配到的文件夹: ['角色1-别名1-别名2']
[INFO] 随机选择文件夹: 角色1-别名1-别名2
[INFO] 找到媒体文件数量: 5
[INFO] 随机选择文件: image1.jpg
[WARN] 检测到别名重名: 输入"敌意"匹配到2个文件夹: 敌意-你好-你好啊, 敌意-第一-帝一
```

## 注意事项

1. **文件夹命名**：使用 `-` 分割别名，避免使用特殊字符
2. **路径配置**：确保 `imagePath` 和 `tempPath` 目录存在且有读写权限
3. **别名重名**：注意查看警告日志，及时调整重名的别名
4. **文件格式**：确保图片和视频文件格式正确
5. **存储空间**：定期清理临时文件夹，避免占用过多存储空间

## 许可证

MIT License
